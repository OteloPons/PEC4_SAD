---
title: "PEC_4"
author: "Enrique Gonzalo Martín / Otelo Pons Alonso"
date: "2025-05-31"
output:
  pdf_document: default
  html_document: default
  toc: true
  toc_depth: 3  
  number_sections: true
  toc_float: true
---

\tableofcontents  
\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Sección 1. Contexto y objetivo del estudio. 

Explicación del dataset escogido para el análisis.

-   Motivos

-   Fuente

-   Descripción de campos

Explicación del análisis que se va ha realizar

Ej: 

* Descubrir cuales son los mejores predictores para la diabetes.

* Crear un modelo para predecir la diabetes


## Inicialización entorno trabajo

```{r}  
# definimos y ponemos el directorio de trabajo 
directorio_trabajo <- paste0(getwd(), ' ')
setwd(directorio_trabajo)  

# instalamos la librerias que vamos a utilizar
install_package <- function(package_name){
  if (!requireNamespace(package_name, quietly = TRUE)) {
    install.packages(package_name) 
  }

install_package("knitr")    # para la generación de tablas mas vistosas
install_package("glue")     # para formatera texto interpolando variables
install_package("ggplot2")  # para los gráficos
install_package("corrplot")
}
```




# Sección 2. Prospección y preparación de los datos

## Descripción del conjunto de datos


![](dataframe_diabetes.png){width="620"}

## Carga del dataset y exploración inicial


```{r}
diabetes_df <- read.csv("data/diabetes.csv")

str(diabetes_df)

```

### Análisis de variables numéricas


```{r}
# Creamos una función para que la podamos reutilizar
estadisticos_columna <- function(col) {
  if (is.numeric(col)) {
    # Si es numérica, devolver resumen estadístico básico y el porcentaje de nulos
    # Para hacer el porcentaje basta con hacer la media del numero de nulos (nºnulos / nº valores de la columna)
    # Para los estadisticos eliminamos los valores faltantes con na.rm=TRUE
    return(c(
      Porcentaje_Nulos = round(mean(is.na(col)) * 100, 2),
      Min = round(min(col, na.rm = TRUE),2),
      Q1 = round(quantile(col, 0.25, na.rm = TRUE),2),
      Median = round(median(col, na.rm = TRUE),2),
      Mean = round(mean(col, na.rm = TRUE),2),
      Sd = round(sd(col, na.rm = TRUE),2),
      Q3 = round(quantile(col, 0.75, na.rm = TRUE),2),
      Max = round(max(col, na.rm = TRUE),2)
    ))
  } 
}

estadisticas_numericas <- function(df) {
  
# Escogemos solo las variables numéricas
columnas_numericas <- df[,sapply(df, function(x) is.numeric(x))]

# Aplicamos la funcion de estadísticos para cada variable
estadisticos <- lapply(columnas_numericas,estadisticos_columna)

# Convertir lista de vectores a data.frame
tabla_resumen <- do.call(rbind, estadisticos)

# Cramos el dataframe final añadiendo el nombre de las variables como primera columna
tabla_resumen <- data.frame(
  Variable = rownames(tabla_resumen),
  tabla_resumen, row.names = NULL)

# Mostrar la tabla de forma bonita
knitr::kable(tabla_resumen,
             caption = "Estadísticos de variables numéricas ",
             align = "lrrrrrrrr")
}

estadisticas_numericas(diabetes_df)
```


### Transformaciones y creación de variables sintéticas

Ej:

* Estandarizar unidades de medida: inches -> meters, puonds -> Kg
```{r}
# función que pasa de pulgadas a metros
inches_to_meters <- function(inches) {
  meters <- inches * 0.0254
  return(meters)
}

# función que pasa de libras a kilos
pounds_to_kilos <- function(pounds){
  kilos <- pounds * 0.453592
}

# altura, cintura y cadera de pulgadas a metros

variables_en_pulgadas <- c("height","hip","waist")

diabetes_df[variables_en_pulgadas] <- lapply(
  diabetes_df[variables_en_pulgadas],
  inches_to_meters
)


# peso de libras a kilos
diabetes_df$weight <- pounds_to_kilos(diabetes_df$weight)


```


* Crear variables nuevas que puedan ser buenos predictores:

  * Indice de masa corporal. $BMI = peso / altura^2$
  
  * Ratio cintura cadera $WHR = waist / hip$

  
```{r}
# indice de masa corporal
diabetes_df$BMI <- diabetes_df$weight / diabetes_df$height^2

# ratio cintura cadera (Waist Hip Ratio)
diabetes_df$WHR <- diabetes_df$waist / diabetes_df$hip
```



Después de hacer las transformaciones y la creación de nuevas variables veamos como queda finalmente nuestro conjunto de datos.
```{r}

estadisticas_numericas(diabetes_df)
```

### Análisis de variables categoricas
* Cambiar algunas variables a tipo factor

```{r}
columnas_factorizables <- c("location", "gender", "frame")

diabetes_df[columnas_factorizables] <- lapply(
  diabetes_df[columnas_factorizables],
  as.factor)

print(str(diabetes_df[columnas_factorizables]))

print(summary(diabetes_df[columnas_factorizables]))
```

* Sintesis de variables categóricas

  * Diabetes: $SI/NO$. Supondremos diabetes tipo 2 si el porcentaje de glucosa o azucar en sangre (glyhb) supera el 6.5% . Para simplificar no crearemos el grupo de prediabetes (glyhb entre 5.7 y 6.4%)
  
  * Hipertenso: $SI/NO$. Supondremos hypertensión si la presión sistólica es mayor de 140 o la diastólica es mayor de 90
  
  
```{r}
# suponemos que es diabético si glyhb >= 6.5
diabetes_df$diabetes <- cut(diabetes_df$glyhb,
                            breaks = c(0,  6.49, Inf),
                            labels = c("NO","SI"),
                            right = TRUE) # right=TRUE => intervalo es (a, b]

diabetes_df$hipertenso <- as.factor(ifelse(
                                      diabetes_df$bp.1s >= 140 |
                                      diabetes_df$bp.1d >= 90,
                                      "SI",
                                      "NO")
                                    )
summary(diabetes_df[,c("diabetes","hipertenso")])
```

# Sección 3. Análisis exploratorio de los datos

## 3.1 Análisis descriptivo
```{r, fig.width=15, fig.height=9}
par(mfrow = c(2, 2)) 

boxplot(glyhb ~ gender, data= diabetes_df)
boxplot(glyhb ~ frame, data= diabetes_df)
boxplot(glyhb ~ location, data= diabetes_df)
boxplot(glyhb ~ hipertenso, data= diabetes_df)

par(mfrow = c(1, 1)) 
```


```{r}
library(ggplot2)


categoricas <- c("gender","frame","location","hipertenso")
plot_list <- list()

for (categorica in categoricas){
  data <- data.frame(
    categorical_var = diabetes_df[categorica],
    target = diabetes_df$glyhb
  )
  
  p <- ggplot(data) +
    geom_boxplot(aes_string(x = categorica, y = "target", fill = categorica), na.rm = TRUE, show.legend = FALSE) +
    theme_minimal()
  
  plot_list[[categorica]] <- p
}
print(plot_list)



```

```{r}
  
# Escogemos solo las variables numéricas
columnas_numericas <- diabetes_df[,sapply(diabetes_df, function(x) is.numeric(x))]

matriz_correlacion <- cor(columnas_numericas, method = "pearson", use = "pairwise.complete.obs")
```


```{r}
library(corrplot)
corrplot(matriz_correlacion,
             method = "circle",      # "circle", "square", "ellipse", "number", "shade", "color", "pie"
             type = "upper",          # "full", "lower", "upper"
             tl.col = "black",      # Color del texto de las etiquetas
             tl.srt = 45,           # Rotación del texto de las etiquetas
             addCoef.col =  NULL, # Añadir coeficientes si el método es 'number' o el tipo es 'full'
             number.cex = 0.7,      # Tamaño de los números si se muestran
             order = "hclust",      # Reordenar variables por clustering jerárquico para ver patrones
             na.label = "NA",       # Etiqueta para NAs en la matriz
             na.label.col = "grey"
            )
```

## 3.2 Estudio probabilístico


# Sección 4. Modelos de aprendizaje automático

 Por ejemplo
 
 * Regresión logística para intentar predecir diabetes.
 
 * Análisis cluster
 

# Sección 5. Visualización

# Sección 6. Conclusiones
